# Откуда берется значение u1 (остаточное напряжение) в результатах

## Краткий ответ

**Значение u1 берется из протокола RASTR** после выполнения динамического расчета. Это **результат расчета**, а не входной параметр.

---

## Подробное объяснение

### 1. Процесс расчета

Когда выполняется расчет шунтов КЗ, происходит следующее:

#### Шаг 1: Определение целевого напряжения (u_target)

```python
# В calculations/shunt_kz.py, строки 131-132
if shunt_node.u1 != -1.0:
    u_target = shunt_node.u1  # Если задано в файле
else:
    u_target = v_initial * 0.66  # Типовое значение (66% от начального)
```

**u_target** - это **целевое значение**, к которому стремится алгоритм.

#### Шаг 2: Итерационный поиск шунта

```python
# В rastr_operations/rastr_operations.py, метод find_shunt_kz()
result = rastr.find_shunt_kz(
    node=shunt_node.node,
    u_ost=u_target,      # Целевое остаточное напряжение
    x_isx=shunt_node.x1,
    r_isx=shunt_node.r1
)
```

#### Шаг 3: Что происходит внутри `find_shunt_kz()`

1. **Создается сценарий КЗ** с начальным сопротивлением шунта
2. **Запускается динамический расчет** через `FWDynamic().Run()`
3. **RASTR выполняет расчет** и выводит результат в протокол
4. **Из протокола извлекается значение** остаточного напряжения

### 2. Извлечение из протокола

```python
# В rastr_operations/rastr_operations.py, строки 356-394

# Обработчик событий перехватывает сообщения из протокола
def on_log_handler(code, level, stage_id, table_name, table_index, description, form_name):
    if code == 0 and "Величина остаточного напряжения в узле" in description:
        prot.append(description)

# После расчета извлекается значение
if prot:
    last_msg = prot[-1]
    # Формат сообщения: "Величина остаточного напряжения в узле ... (Uкз=XXX кВ, ...)"
    u_kz_str = last_msg.split("Uкз=")[1].split(" кВ")[0]
    u_current = float(u_kz_str)
```

**Формат сообщения в протоколе RASTR:**
```
"Величина остаточного напряжения в узле <номер> (Uкз=XXX кВ, ...)"
```

### 3. Итерационный процесс

Алгоритм работает итеративно:

```python
while abs(u_current - u_ost) > precision:
    # Корректировка сопротивления шунта
    z_mod = z_mod * u_ost / u_current
    
    # Создание нового сценария
    self._create_shunt_scn(node, ...)
    
    # Повторный расчет
    fw_dynamic.Run()
    
    # Извлечение нового значения из протокола
    u_current = извлечь_из_протокола()
```

**Цель:** Найти такое сопротивление шунта, при котором остаточное напряжение будет максимально близко к целевому значению.

### 4. Запись в результаты

```python
# В calculations/shunt_kz.py, строки 136-138
result = rastr.find_shunt_kz(...)
shunt_result.r1 = result.r  # Сопротивление шунта
shunt_result.x1 = result.x  # Реактивное сопротивление
shunt_result.u1 = result.u  # ← ЗДЕСЬ! Остаточное напряжение из протокола
```

---

## Итоговая схема

```
┌─────────────────────────────────────────────────────────┐
│ 1. Входные данные                                        │
│    - u_target (целевое напряжение)                       │
│      • Из файла задания (shunt_node.u1)                  │
│      • Или типовое: v_initial * 0.66                     │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│ 2. Итерационный поиск (find_shunt_kz)                   │
│    ┌─────────────────────────────────────┐              │
│    │ a) Создать сценарий КЗ              │              │
│    │ b) Запустить FWDynamic().Run()       │              │
│    │ c) RASTR выполняет расчет            │              │
│    │ d) RASTR пишет в протокол:           │              │
│    │    "Величина остаточного напряжения  │              │
│    │     в узле ... (Uкз=XXX кВ, ...)"    │              │
│    │ e) Извлечь u_current из протокола    │              │
│    │ f) Сравнить с u_target              │              │
│    │ g) Если не совпадает → повторить    │              │
│    └─────────────────────────────────────┘              │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│ 3. Результат                                             │
│    result.u = u_current  ← ИЗ ПРОТОКОЛА RASTR!           │
│    shunt_result.u1 = result.u                            │
└─────────────────────────────────────────────────────────┘
```

---

## Важные моменты

### ✅ u1 - это РЕЗУЛЬТАТ расчета
- **НЕ** берется из входных данных напрямую
- **НЕ** вычисляется по формуле
- **Берется из протокола RASTR** после динамического расчета

### ✅ Итерационный процесс
- Алгоритм подбирает сопротивление шунта
- Каждая итерация дает новое значение u_current
- Процесс продолжается до достижения нужной точности

### ✅ Точность
```python
precision = min(2.0, 0.02 * u_nom)  # 2 кВ или 2% от номинального
```

### ✅ Формат протокола
Сообщение в протоколе имеет формат:
```
"Величина остаточного напряжения в узле <номер> (Uкз=XXX кВ, ...)"
```

Из этого сообщения извлекается значение `XXX` и записывается в `u1`.

---

## Пример

1. **Вход:** u_target = 100 кВ (целевое значение)
2. **Расчет:** RASTR выполняет динамический расчет
3. **Протокол:** "Величина остаточного напряжения в узле 5 (Uкз=98.5 кВ, ...)"
4. **Извлечение:** u_current = 98.5 кВ
5. **Сравнение:** |98.5 - 100| = 1.5 кВ > precision → нужна еще итерация
6. **Корректировка:** z_mod = z_mod * 100 / 98.5
7. **Повтор:** Новый расчет → новое значение из протокола
8. **Результат:** Когда |u_current - u_target| ≤ precision → записать u1 = u_current

---

## Код в исходниках

### C# (оригинал):
```csharp
// Строка 324: Извлечение из протокола
double num3 = Convert.ToDouble(_prot.LastOrDefault()
    .Split('(')[1]
    .Split(',')[0]
    .Replace(" кВ", "")
    .Replace("Uкз=", "")
    .Replace(".", ...));

// Строка 345: Запись в результат
u = num3  // ← Значение из протокола
```

### Python (наша реализация):
```python
# Строки 361-362: Извлечение из протокола
u_kz_str = last_msg.split("Uкз=")[1].split(" кВ")[0]
u_current = float(u_kz_str)

# Строка 394: Запись в результат
u=u_current  # ← Значение из протокола
```

---

## Вывод

**u1 берется из протокола RASTR** после выполнения динамического расчета. Это **результат расчета**, который RASTR выводит в протокол в формате `"Uкз=XXX кВ"`, и программа извлекает это значение для записи в результаты.

