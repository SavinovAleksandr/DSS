# Генерация лицензий для StabLimit

## Обзор

Эта утилита позволяет создавать файлы лицензий для программы StabLimit. Лицензия привязана к имени компьютера и проверяется при запуске программы.

---

## Быстрый старт

### 1. Автоматическая генерация (для текущего компьютера)

```bash
cd python_dss
python utils/license_generator.py
```

Утилита автоматически:
- Определит имя текущего компьютера
- Разделит его на части
- Создаст файл лицензии по пути по умолчанию (`C:/ПАРУС 6/licence.txt`)

### 2. Указание пути вручную

```bash
python utils/license_generator.py "C:/ПАРУС 6/licence.txt"
```

### 3. Генерация для другого компьютера

```bash
python utils/license_generator.py
# Когда спросит имя компьютера - введите нужное
```

---

## Как это работает

### Алгоритм генерации

1. **Получение имени компьютера**
   - Автоматически: `COMPUTERNAME` или `HOSTNAME`
   - Вручную: можно указать при запуске

2. **Разделение имени на части**
   - Имя делится на 3 части (примерно поровну)
   - Обрабатываются дефисы

3. **Создание файла лицензии**
   - Минимум 53 строки
   - Строка 43: содержит первую часть имени
   - Строка 45: содержит вторую часть имени
   - Строка 46: содержит третью часть имени
   - Строка 52: содержит маркер "p5"

### Пример

**Имя компьютера:** `DESKTOP-ABC123` (15 символов)

**Разделение:**
- `num = 15 // 3 = 5`
- `num2 = 15 - 2*5 = 5`
- Часть 1: `"DESKT"` → строка 43
- Часть 2: `"OP-AB"` → строка 45 (дефис обрабатывается)
- Часть 3: `"C123"` → строка 46
- Маркер: `"p5"` → строка 52

---

## Структура файла лицензии

```
Строка 0:  License line 1
Строка 1:  License line 2
...
Строка 43: License information: DESKT - Part 1 of machine name
Строка 44: License line 45
Строка 45: License information: OP-AB - Part 2 of machine name
Строка 46: License information: C123 - Part 3 of machine name
Строка 47: License line 48
...
Строка 52: License key: p5 - StabLimit License
```

---

## Использование в коде

### Программная генерация

```python
from utils.license_generator import generate_license_file
from pathlib import Path

# Генерация для текущего компьютера
machine_name = "DESKTOP-ABC123"
output_path = Path("C:/ПАРУС 6/licence.txt")

success = generate_license_file(machine_name, output_path)
if success:
    print("Лицензия создана!")
```

### Генерация с кастомным текстом

```python
custom_text = """
Лицензия StabLimit
Версия 1.0
...
"""

generate_license_file(
    machine_name="DESKTOP-ABC123",
    output_path=Path("C:/ПАРУС 6/licence.txt"),
    license_text=custom_text
)
```

---

## Важные моменты

### ✅ Требования

1. **Файл должен иметь минимум 53 строки**
2. **Строки 43, 45, 46, 52 должны содержать нужные данные**
3. **Путь к файлу** должен соответствовать настройкам в конфиге

### ⚠️ Ограничения

1. **Привязка к имени компьютера**
   - Лицензия работает только на компьютере с указанным именем
   - При смене имени компьютера нужно создать новую лицензию

2. **Путь к файлу**
   - По умолчанию: `C:/ПАРУС 6/licence.txt`
   - Можно изменить в `config.yaml`

3. **Простая защита**
   - Это не криптографическая защита
   - Файл можно скопировать на другой компьютер (но не будет работать из-за привязки к имени)

---

## Проверка лицензии

После создания лицензии можно проверить её:

```python
from utils.license import check_license

try:
    if check_license():
        print("✅ Лицензия валидна")
    else:
        print("❌ Лицензия невалидна")
except Exception as e:
    print(f"❌ Ошибка: {e}")
```

---

## Устранение проблем

### Проблема: "Файл лицензии не обнаружен"

**Решение:**
1. Проверьте путь к файлу в конфиге
2. Убедитесь, что файл существует
3. Проверьте права доступа

### Проблема: "Некорректный файл лицензии"

**Решение:**
1. Убедитесь, что файл имеет минимум 53 строки
2. Проверьте, что строки 43, 45, 46, 52 содержат правильные данные
3. Пересоздайте лицензию с помощью утилиты

### Проблема: Лицензия не работает после смены имени компьютера

**Решение:**
1. Определите новое имя компьютера
2. Создайте новую лицензию для нового имени
3. Замените старый файл лицензии

---

## Примеры использования

### Пример 1: Генерация для разработки

```bash
# Создать лицензию для текущего компьютера
python utils/license_generator.py

# Проверить лицензию
python -c "from utils.license import check_license; print('OK' if check_license() else 'FAIL')"
```

### Пример 2: Генерация для продакшена

```bash
# Создать лицензию для конкретного компьютера
python utils/license_generator.py "C:/ПАРУС 6/licence.txt"
# Ввести имя компьютера при запросе
```

### Пример 3: Массовая генерация

```python
# Скрипт для генерации лицензий для нескольких компьютеров
from utils.license_generator import generate_license_file
from pathlib import Path

computers = [
    "DESKTOP-ABC123",
    "WORKSTATION-XYZ",
    "SERVER-001"
]

for computer in computers:
    output = Path(f"licenses/{computer}_licence.txt")
    generate_license_file(computer, output)
    print(f"Создана лицензия для {computer}")
```

---

## Безопасность

### ⚠️ Важно понимать

Эта система лицензирования **не является криптографически защищенной**. Она предназначена для:
- Контроля использования программы
- Привязки к конкретному компьютеру
- Простой проверки легитимности

### Рекомендации

1. **Для продакшена** рассмотрите более сложную систему лицензирования
2. **Для разработки** эта система достаточна
3. **Для защиты** можно добавить:
   - Криптографическую подпись
   - Онлайн-проверку
   - Хеширование данных

---

## Дополнительная информация

- См. `utils/license.py` - код проверки лицензии
- См. `utils/config.py` - настройки путей
- См. `docs/LICENSE_ANALYSIS.md` - анализ механизма лицензирования

